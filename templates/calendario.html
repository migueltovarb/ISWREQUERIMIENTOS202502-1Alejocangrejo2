{% extends 'base.html' %}

{% block content %}
<style>
    .wrap {
        max-width: 1000px;
        margin: 20px auto;
        padding: 0 14px
    }

    header {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px
    }

    h1 {
        font-size: 18px;
        margin: 0 8px 0 0
    }

    select,
    input[type="date"] {
        background: #0b1220;
        border: 1px solid var(--line);
        color: var(--text);
        padding: 6px 8px;
        border-radius: 0
    }

    button {
        background: #0b1220;
        border: 1px solid var(--line);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 0;
        cursor: pointer
    }

    button.primary {
        background: var(--brand);
        border-color: var(--brand);
        color: #fff;
        font-weight: 600
    }

    .legend {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 8px 0
    }

    .chip {
        display: flex;
        align-items: center;
        gap: 6px;
        border: 1px solid var(--line);
        padding: 4px 8px;
        border-radius: 0;
        font-size: 12px;
        color: var(--muted)
    }

    .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%
    }

    .calendar {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 0;
        overflow: hidden
    }

    .head {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        border-bottom: 1px solid var(--line);
    }

    .head div {
        padding: 8px;
        font-size: 12px;
        color: var(--muted);
        text-align: center
    }

    .grid-month {
        display: grid;
        grid-template-columns: repeat(7, 1fr)
    }

    .cell {
        min-height: 110px;
        border-top: 1px solid var(--line);
        border-left: 1px solid var(--line);
        padding: 6px
    }

    .cell:nth-child(7n+1) {
        border-left: none
    }

    .dnum {
        font-size: 12px;
        color: var(--muted);
        text-align: right
    }

    .pill {
        margin-top: 6px;
        font-size: 12px;
        border-left: 3px solid #0003;
        background: #0b1220;
        border: 1px solid var(--line);
        padding: 6px;
        border-radius: 0;
        cursor: pointer
    }

    .grid-week {
        display: grid;
        grid-template-columns: 120px repeat(7, 1fr)
    }

    .hour {
        border-top: 1px solid var(--line);
        padding: 8px;
        color: var(--muted);
        font-size: 12px
    }

    .slot {
        border-top: 1px solid var(--line);
        border-left: 1px solid var(--line);
        min-height: 48px;
        padding: 6px
    }

    .empty {
        padding: 20px;
        text-align: center;
        color: var(--muted)
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(11, 12, 15, 0.9)
    }

    .modal-content {
        background: var(--panel);
        margin: 10% auto;
        padding: 20px;
        border: 1px solid var(--line);
        border-radius: 0;
        width: 90%;
        max-width: 480px
    }

    .modal-header {
        font-size: 18px;
        font-weight: 600;
        color: var(--brand);
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--line)
    }

    .modal-close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted)
    }

    .modal-close:hover {
        color: var(--danger)
    }

    details {
        margin-top: 12px;
        border: 1px solid var(--line);
        border-radius: 0
    }

    details summary {
        cursor: pointer;
        padding: 8px 10px;
        color: var(--muted)
    }

    table {
        width: 100%;
        border-collapse: collapse
    }

    td,
    th {
        border-top: 1px solid var(--line);
        padding: 8px;
        font-size: 12px
    }
</style>

<div class="wrap">
    <header>
        <h1>Calendario de Reservas</h1>
        <button id="prev">â—€</button>
        <button id="today">Hoy</button>
        <button id="next">â–¶</button>
        <select id="view">
            <option value="day">DÃ­a</option>
            <option value="week" selected>Semana</option>
            <option value="month">Mes</option>
        </select>
        <span id="range" style="color:var(--muted);font-size:12px"></span>
        <select id="lab">
            <option value="">Todos los labs</option>
        </select>
        <select id="equip">
            <option value="">Todos los equipos</option>
        </select>
        <button id="apply" class="primary">Filtrar</button>
        <button id="nuevaReserva" class="primary">+ Nueva Reserva</button>
    </header>

    <div class="legend">
        <span class="chip"><span class="dot" style="background:var(--ok)"></span>Activa</span>
        <span class="chip"><span class="dot" style="background:var(--muted)"></span>Completada</span>
        <span class="chip"><span class="dot" style="background:var(--danger)"></span>Cancelada</span>
    </div>

    <section id="cal" class="calendar" aria-live="polite"></section>

    <details open>
        <summary>ðŸ§¾ Log de actividad</summary>
        <div style="max-height:180px;overflow:auto">
            <table id="logs">
                <thead>
                    <tr>
                        <th>Fecha/Hora</th>
                        <th>AcciÃ³n</th>
                        <th>Detalles</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </details>
</div>

<!-- Modal Detalles -->
<div id="modalDetalles" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="cerrarModal('modalDetalles')">&times;</span>
            Detalles de Reserva
        </div>
        <div id="detallesBody"></div>
        <div style="display:flex;gap:8px;margin-top:16px">
            <button id="btnCancelar" class="btn-danger" style="display:none">Cancelar Reserva</button>
            <button onclick="cerrarModal('modalDetalles')">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal Nueva Reserva -->
<div id="modalNueva" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="cerrarModal('modalNueva')">&times;</span>
            Nueva Reserva
        </div>
        <form id="formReserva">
            <div class="form-group">
                <label>Equipo</label>
                <select id="equipoReserva" required></select>
            </div>
            <div class="form-group">
                <label>Fecha y Hora Inicio</label>
                <input type="datetime-local" id="inicioReserva" required>
            </div>
            <div class="form-group">
                <label>Fecha y Hora Fin</label>
                <input type="datetime-local" id="finReserva" required>
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button type="submit" class="btn-primary">Crear Reserva</button>
                <button type="button" onclick="cerrarModal('modalNueva')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ===== Estado y configuraciÃ³n =====
    const state = {
        cursor: new Date(),
        view: 'week',
        filters: { lab: '', equip: '' },
        events: [],
        laboratorios: [],
        equipos: []
    };

    // ===== Cargar datos desde API =====
    async function cargarLaboratorios() {
        const res = await fetch('/api/laboratorios/');
        state.laboratorios = await res.json();
        state.laboratorios.forEach(l => lab.append(new Option(l.nombre, l.id)));
    }

    async function cargarEquipos() {
        const res = await fetch('/api/equipos/');
        state.equipos = await res.json();
        state.equipos.forEach(e => {
            equip.append(new Option(e.codigo, e.id));
            equipoReserva.append(new Option(e.codigo, e.id));
        });
    }

    async function cargarReservas() {
        const res = await fetch('/api/reservas/');
        const data = await res.json();
        state.events = data.map(r => ({
            id: r.id,
            inicio: new Date(r.fecha_inicio),
            fin: new Date(r.fecha_fin),
            laboratorio: r.laboratorio_nombre || 'Lab',
            equipo: r.equipo_codigo || 'Equipo',
            estado: r.estado,
            usuario: r.usuario_nombre || 'Usuario'
        }));
        render();
    }

    // ===== NavegaciÃ³n =====
    prev.onclick = () => { move(-1) };
    next.onclick = () => { move(1) };
    today.onclick = () => { state.cursor = new Date(); render(); log('Volver a hoy', {}) };
    view.onchange = () => { state.view = view.value; render(); log('Cambio de vista', { vista: state.view }) };
    apply.onclick = () => {
        state.filters = { lab: lab.value, equip: equip.value };
        render();
        log('Aplicar filtros', state.filters);
    };

    function move(n) {
        if (state.view === 'day') state.cursor = addDays(state.cursor, n);
        if (state.view === 'week') state.cursor = addDays(state.cursor, n * 7);
        if (state.view === 'month') state.cursor = addMonths(state.cursor, n);
        render();
        log('Navegar', { direccion: n, vista: state.view });
    }

    // ===== Renderizado =====
    function render() {
        const el = document.getElementById('cal');
        el.innerHTML = '';

        const evs = state.events.filter(f => {
            if (state.filters.equip && f.equipo !== state.equipos.find(e => e.id == state.filters.equip)?.codigo) return false;
            return true;
        });

        if (state.view === 'month') drawMonth(evs);
        else if (state.view === 'day') drawDay(evs);
        else drawWeek(evs);

        if (!el.querySelector('[data-ev]')) {
            el.innerHTML += `<div class="empty">No hay reservas para mostrar</div>`;
        }
    }

    function drawMonth(events) {
        const first = new Date(state.cursor.getFullYear(), state.cursor.getMonth(), 1);
        const start = startOfWeek(first);
        const end = endOfWeek(new Date(state.cursor.getFullYear(), state.cursor.getMonth() + 1, 0));
        range.textContent = fmt(first, 'MMMM yyyy');

        const head = document.createElement('div');
        head.className = 'head';
        ['Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b', 'Dom'].forEach(d => {
            const x = document.createElement('div');
            x.textContent = d;
            head.appendChild(x);
        });
        cal.appendChild(head);

        const grid = document.createElement('div');
        grid.className = 'grid-month';
        for (let d = new Date(start); d <= end; d = addDays(d, 1)) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerHTML = `<div class="dnum">${d.getDate()}</div>`;
            events.filter(e => sameDay(e.inicio, d)).slice(0, 3).forEach(e => cell.appendChild(pill(e)));
            grid.appendChild(cell);
        }
        cal.appendChild(grid);
    }

    function drawWeek(events) {
        const s = startOfWeek(state.cursor);
        const e = endOfWeek(state.cursor);
        range.textContent = `${fmt(s, 'd MMM')} â€“ ${fmt(e, 'd MMM, yyyy')}`;

        const head = document.createElement('div');
        head.className = 'head';
        ['Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b', 'Dom'].forEach(d => {
            const x = document.createElement('div');
            x.textContent = d;
            head.appendChild(x);
        });
        cal.appendChild(head);

        const grid = document.createElement('div');
        grid.className = 'grid-week';
        const hours = [8, 10, 12, 14, 16, 18];
        hours.forEach(h => {
            const hr = document.createElement('div');
            hr.className = 'hour';
            hr.textContent = (h + '').padStart(2, '0') + ':00';
            grid.appendChild(hr);

            for (let i = 0; i < 7; i++) {
                const d = addDays(s, i);
                const slot = document.createElement('div');
                slot.className = 'slot';
                events.filter(ev => sameDay(ev.inicio, d) && ev.inicio.getHours() === h).forEach(ev => slot.appendChild(pill(ev)));
                grid.appendChild(slot);
            }
        });
        cal.appendChild(grid);
    }

    function drawDay(events) {
        const d = state.cursor;
        range.textContent = fmt(d, 'EEEE d MMM, yyyy');
        const list = document.createElement('div');
        events.filter(e => sameDay(e.inicio, d)).sort((a, b) => a.inicio - b.inicio).forEach(e => list.appendChild(pill(e)));
        cal.appendChild(list);
    }

    function pill(ev) {
        const el = document.createElement('div');
        el.className = 'pill';
        el.dataset.ev = ev.id;
        el.style.borderLeftColor = ev.estado === 'ACTIVA' ? 'var(--ok)' : ev.estado === 'COMPLETADA' ? 'var(--muted)' : 'var(--danger)';
        el.textContent = `${hhmm(ev.inicio)}â€“${hhmm(ev.fin)} â€¢ ${ev.equipo} â€¢ ${ev.estado}`;
        el.onclick = () => mostrarDetalles(ev);
        return el;
    }

    // ===== Modales =====
    function mostrarDetalles(ev) {
        detallesBody.innerHTML = `
    <div><strong>Fecha:</strong> ${fmt(ev.inicio, 'EEEE d MMM yyyy')}</div>
    <div><strong>Hora:</strong> ${hhmm(ev.inicio)} â€“ ${hhmm(ev.fin)}</div>
    <div><strong>Equipo:</strong> ${ev.equipo}</div>
    <div><strong>Estado:</strong> ${ev.estado}</div>
    <div><strong>Usuario:</strong> ${ev.usuario}</div>
  `;

        if (ev.estado === 'ACTIVA') {
            btnCancelar.style.display = 'block';
            btnCancelar.onclick = () => cancelarReserva(ev.id);
        } else {
            btnCancelar.style.display = 'none';
        }

        document.getElementById('modalDetalles').style.display = 'block';
        log('Ver detalles', { id: ev.id });
    }

    nuevaReserva.onclick = () => {
        document.getElementById('modalNueva').style.display = 'block';
    };

    formReserva.onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            equipo: parseInt(equipoReserva.value),
            fecha_inicio: new Date(inicioReserva.value).toISOString(),
            fecha_fin: new Date(finReserva.value).toISOString()
        };

        try {
            const res = await fetch('/api/reservas/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Reserva creada exitosamente');
                cerrarModal('modalNueva');
                cargarReservas();
                log('Crear reserva', data);
            } else {
                const error = await res.json();
                alert('Error: ' + JSON.stringify(error));
            }
        } catch (error) {
            alert('Error de conexiÃ³n');
        }
    };

    async function cancelarReserva(id) {
        if (!confirm('Â¿Cancelar esta reserva?')) return;

        try {
            const res = await fetch(`/api/reservas/${id}/cancelar/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });

            if (res.ok) {
                alert('Reserva cancelada');
                cerrarModal('modalDetalles');
                cargarReservas();
                log('Cancelar reserva', { id });
            }
        } catch (error) {
            alert('Error');
        }
    }

    function cerrarModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ===== Utilidades =====
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function log(accion, params) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmt(new Date(), 'yyyy-MM-dd HH:mm:ss')}</td><td>${accion}</td><td><code>${JSON.stringify(params || {})}</code></td>`;
        logs.querySelector('tbody').prepend(tr);
    }

    function hhmm(d) { return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') }
    function sameDay(a, b) { return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate() }
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x }
    function addMonths(d, n) { const x = new Date(d); x.setMonth(x.getMonth() + n); return x }
    function startOfWeek(d) { const x = new Date(d); const w = (x.getDay() + 6) % 7; x.setDate(x.getDate() - w); x.setHours(0, 0, 0, 0); return x }
    function endOfWeek(d) { const s = startOfWeek(d); return addDays(s, 6) }
    function fmt(d, mask) {
        const pad = n => String(n).padStart(2, '0');
        const MMM = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
        const MMMM = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const EEEE = ['lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado', 'domingo'][(d.getDay() + 6) % 7];
        return mask.replace(/yyyy|MM|dd|d|MMM|MMMM|HH|mm|EEEE/g, m => ({
            yyyy: d.getFullYear(),
            MM: pad(d.getMonth() + 1),
            dd: pad(d.getDate()),
            d: d.getDate(),
            MMM: MMM[d.getMonth()],
            MMMM: MMMM[d.getMonth()],
            HH: pad(d.getHours()),
            mm: pad(d.getMinutes()),
            EEEE: EEEE
        })[m])
    }

    // ===== InicializaciÃ³n =====
    cargarLaboratorios();
    cargarEquipos();
    cargarReservas();
    render();
</script>
{% endblock %}
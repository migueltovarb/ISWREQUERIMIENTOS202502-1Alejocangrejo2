{% extends 'base.html' %}

{% block content %}
<style>
    .kpis {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
        margin-bottom: 24px
    }

    .kpi {
        background: #0d1118;
        border: 1px solid var(--line);
        border-radius: 0;
        padding: 16px
    }

    .kpi .label {
        color: var(--muted);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px
    }

    .kpi .value {
        font-size: 36px;
        font-weight: 800;
        margin-top: 8px;
        color: var(--brand)
    }

    .kpi .delta {
        font-size: 12px;
        margin-top: 6px
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px
    }

    .labs {
        display: grid;
        gap: 12px
    }

    .lab {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #0d1118;
        border: 1px solid var(--line);
        border-radius: 0;
        padding: 12px
    }

    .bar {
        flex: 1;
        height: 12px;
        background: #141a26;
        border-radius: 0;
        position: relative;
        overflow: hidden
    }

    .bar>i {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: linear-gradient(90deg, #26c6da, #4da3ff)
    }

    .badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 0;
        border: 1px solid var(--line);
        background: #0b1323;
        color: var(--muted)
    }

    .badge.alert {
        background: #2a0f12;
        border-color: #6e1a25;
        color: #ffbdbd
    }

    canvas {
        width: 100%;
        height: 200px;
        display: block;
        background: #0d1118;
        border: 1px solid var(--line);
        border-radius: 0;
        margin-top: 12px
    }

    .users-list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px
    }

    .user-item {
        background: #0d1118;
        border: 1px solid var(--line);
        border-radius: 0;
        padding: 10px;
        font-size: 13px
    }

    @media (max-width:1000px) {

        .kpis,
        .grid {
            grid-template-columns: 1fr
        }

        .users-list {
            grid-template-columns: 1fr
        }
    }
</style>

<h1 class="mb-3">Dashboard en tiempo real</h1>
<p class="lead" style="color:var(--muted);margin-bottom:24px">
    Métricas operativas de laboratorios • <span id="lastUpdate" class="status">—</span>
</p>

<section class="kpis" id="kpis">
    <div class="kpi">
        <div class="label">Ocupación total</div>
        <div class="value" id="kpi-ocupacion">—%</div>
        <div class="delta ok" id="kpi-ocupacion-delta"></div>
    </div>
    <div class="kpi">
        <div class="label">Reservas activas</div>
        <div class="value" id="kpi-activos">—</div>
        <div class="delta ok" id="kpi-activos-delta"></div>
    </div>
    <div class="kpi">
        <div class="label">Equipos disponibles</div>
        <div class="value" id="kpi-disponibles">—</div>
        <div class="delta warn" id="kpi-disponibles-delta"></div>
    </div>
</section>

<section class="grid">
    <div class="card">
        <div class="card-header">Ocupación por laboratorio</div>
        <div id="labs" class="labs"></div>
    </div>

    <div class="card">
        <div class="card-header">Reservas activas ahora</div>
        <ul id="activeUsers" class="users-list" style="list-style:none;padding:0;margin:0"></ul>
    </div>
</section>

<script>
    // ===== Estado y configuración =====
    const state = {
        laboratorios: [],
        equipos: [],
        reservas: [],
        last: { ocup: 0, activos: 0, disponibles: 0 }
    };

    // ===== Cargar datos desde API =====
    async function cargarLaboratorios() {
        const res = await fetch('/api/laboratorios/');
        state.laboratorios = await res.json();
        renderLabs();
    }

    async function cargarEquipos() {
        const res = await fetch('/api/equipos/');
        state.equipos = await res.json();
        renderKpis();
    }

    async function cargarReservas() {
        const res = await fetch('/api/reservas/');
        const data = await res.json();

        // Filtrar solo reservas activas que están en curso ahora
        const ahora = new Date();
        state.reservas = data.filter(r => {
            const inicio = new Date(r.fecha_inicio);
            const fin = new Date(r.fecha_fin);
            return r.estado === 'ACTIVA' && inicio <= ahora && fin >= ahora;
        });

        renderActiveUsers();
        renderKpis();
    }

    // ===== Renderizado =====
    function renderKpis() {
        if (!state.equipos.length || !state.laboratorios.length) return;

        const totalCapacidad = state.laboratorios.reduce((sum, l) => sum + (l.aforo_maximo || 0), 0);
        const reservasActivas = state.reservas.length;
        const ocupacion = totalCapacidad > 0 ? Math.round((reservasActivas / totalCapacidad) * 100) : 0;
        const disponibles = state.equipos.filter(e => e.estado === 'DISPONIBLE').length;

        document.getElementById('kpi-ocupacion').textContent = `${ocupacion}%`;
        document.getElementById('kpi-activos').textContent = reservasActivas;
        document.getElementById('kpi-disponibles').textContent = disponibles;

        // Deltas (simulado)
        const dO = ocupacion - state.last.ocup;
        const dA = reservasActivas - state.last.activos;
        const dD = disponibles - state.last.disponibles;

        updateDelta('kpi-ocupacion-delta', dO);
        updateDelta('kpi-activos-delta', dA);
        updateDelta('kpi-disponibles-delta', dD);

        state.last = { ocup: ocupacion, activos: reservasActivas, disponibles };
    }

    function updateDelta(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        const text = val > 0 ? `▲ +${val}` : val < 0 ? `▼ ${val}` : '• 0';
        el.textContent = text;
        el.className = `delta ${val > 0 ? 'ok' : val < 0 ? 'danger' : 'warn'}`;
    }

    function renderLabs() {
        const wrap = document.getElementById('labs');
        if (!wrap) return;
        wrap.innerHTML = '';

        state.laboratorios.forEach(lab => {
            // Contar reservas activas en este lab
            const reservasEnLab = state.reservas.filter(r =>
                r.laboratorio_nombre === lab.nombre ||
                state.equipos.find(e => e.id === r.equipo && e.laboratorio === lab.id)
            ).length;

            const pct = lab.aforo_maximo > 0 ? Math.round((reservasEnLab / lab.aforo_maximo) * 100) : 0;

            const div = document.createElement('div');
            div.className = 'lab';
            const alert = pct >= 90 ? '<span class="badge alert">Alta demanda</span>' : `<span class="badge">${pct}%</span>`;
            div.innerHTML = `
      <strong style="min-width:80px">${lab.nombre}</strong>
      <div class="bar"><i style="width:${Math.min(pct, 100)}%"></i></div>
      <span>${reservasEnLab}/${lab.aforo_maximo}</span>
      ${alert}
    `;
            wrap.appendChild(div);
        });
    }

    function renderActiveUsers() {
        const ul = document.getElementById('activeUsers');
        if (!ul) return;
        ul.innerHTML = '';

        if (state.reservas.length === 0) {
            ul.innerHTML = '<li class="user-item" style="grid-column:1/-1;text-align:center;color:var(--muted)">No hay reservas activas en este momento</li>';
            return;
        }

        state.reservas.slice(0, 10).forEach(r => {
            const li = document.createElement('li');
            li.className = 'user-item';
            const inicio = new Date(r.fecha_inicio).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
            const fin = new Date(r.fecha_fin).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
            li.innerHTML = `<strong>${r.usuario_nombre || 'Usuario'}</strong><br>
      <small style="color:var(--muted)">${r.equipo_codigo || 'Equipo'} • ${inicio}–${fin}</small>`;
            ul.appendChild(li);
        });
    }

    // ===== Actualización automática =====
    function updateTimestamp() {
        const now = new Date();
        const time = now.toLocaleString('es', { dateStyle: 'medium', timeStyle: 'short' });
        const el = document.getElementById('lastUpdate');
        if (el) el.textContent = `Actualizado: ${time}`;
    }

    async function refresh() {
        await Promise.all([
            cargarLaboratorios(),
            cargarEquipos(),
            cargarReservas()
        ]);
        updateTimestamp();
    }

    // Inicializar
    refresh();

    // Auto-refresh cada 30 segundos
    setInterval(refresh, 30000);
</script>
{% endblock %}